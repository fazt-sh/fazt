<!DOCTYPE html>
<html lang="en">
<head>
  <!-- BUILD: 2026-02-01 - Panel-based layout migration -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fazt Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;550;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
      --sidebar-width: 224px;
      --sidebar-collapsed: 56px;
      --footer-height: 36px;
    }

    html, body { height: 100%; overflow: hidden; margin: 0; }
    body { font-family: var(--font-sans); }
    .mono { font-family: var(--font-mono); }

    /* STONE PALETTE (Default) */
    :root {
      --bg-0: #faf9f7;
      --bg-1: #ffffff;
      --bg-2: #f3f1ed;
      --bg-3: #e8e4dd;
      --border: #e0dbd3;
      --border-subtle: #ebe7e0;
      --text-1: #1a1816;
      --text-2: #4a4641;
      --text-3: #8a857d;
      --text-4: #b5afa5;
      --accent: #d97706;
      --accent-hover: #b45309;
      --accent-soft: #fef3c7;
      --accent-text: #92400e;
      --success: #16a34a;
      --success-soft: #dcfce7;
      --warning: #ca8a04;
      --warning-soft: #fef9c3;
      --error: #dc2626;
      --error-soft: #fee2e2;
    }

    .dark {
      --bg-0: #0f0e0d;
      --bg-1: #1a1918;
      --bg-2: #262422;
      --bg-3: #33302d;
      --border: #33302d;
      --border-subtle: #262422;
      --text-1: #f5f3f0;
      --text-2: #c4bfb8;
      --text-3: #7a756d;
      --text-4: #524e48;
      --accent: #f59e0b;
      --accent-hover: #fbbf24;
      --accent-soft: #451a03;
      --accent-text: #fcd34d;
      --success: #22c55e;
      --success-soft: #14532d;
      --warning: #eab308;
      --warning-soft: #422006;
      --error: #ef4444;
      --error-soft: #450a0a;
    }

    /* SLATE */
    .palette-slate {
      --bg-0: #f8fafc; --bg-1: #ffffff; --bg-2: #f1f5f9; --bg-3: #e2e8f0;
      --border: #cbd5e1; --border-subtle: #e2e8f0;
      --text-1: #0f172a; --text-2: #475569; --text-3: #94a3b8; --text-4: #cbd5e1;
      --accent: #0284c7; --accent-hover: #0369a1; --accent-soft: #e0f2fe; --accent-text: #0c4a6e;
    }
    .dark.palette-slate {
      --bg-0: #020617; --bg-1: #0f172a; --bg-2: #1e293b; --bg-3: #334155;
      --border: #334155; --border-subtle: #1e293b;
      --text-1: #f1f5f9; --text-2: #94a3b8; --text-3: #64748b; --text-4: #475569;
      --accent: #38bdf8; --accent-hover: #7dd3fc; --accent-soft: #0c4a6e; --accent-text: #bae6fd;
    }

    /* OXIDE */
    .palette-oxide {
      --bg-0: #faf8f8; --bg-1: #ffffff; --bg-2: #f5f0f0; --bg-3: #ebe4e4;
      --border: #e0d6d6; --border-subtle: #ebe4e4;
      --text-1: #1c1617; --text-2: #4a4244; --text-3: #8a8082; --text-4: #b5acae;
      --accent: #e11d48; --accent-hover: #be123c; --accent-soft: #ffe4e6; --accent-text: #9f1239;
    }
    .dark.palette-oxide {
      --bg-0: #0d0a0a; --bg-1: #1a1516; --bg-2: #262020; --bg-3: #332b2c;
      --border: #332b2c; --border-subtle: #262020;
      --text-1: #f5f0f0; --text-2: #c4bcbd; --text-3: #7a7072; --text-4: #524a4b;
      --accent: #fb7185; --accent-hover: #fda4af; --accent-soft: #4c0519; --accent-text: #fecdd3;
    }

    /* FOREST */
    .palette-forest {
      --bg-0: #f7faf8; --bg-1: #ffffff; --bg-2: #ecf4ef; --bg-3: #dceae1;
      --border: #c6ddd0; --border-subtle: #dceae1;
      --text-1: #14201a; --text-2: #3d4f46; --text-3: #7a9187; --text-4: #a8c0b4;
      --accent: #059669; --accent-hover: #047857; --accent-soft: #d1fae5; --accent-text: #065f46;
    }
    .dark.palette-forest {
      --bg-0: #0a0f0c; --bg-1: #141f18; --bg-2: #1e2f25; --bg-3: #2a4034;
      --border: #2a4034; --border-subtle: #1e2f25;
      --text-1: #ecf4ef; --text-2: #a8c0b4; --text-3: #6b8a7a; --text-4: #3d5a4a;
      --accent: #34d399; --accent-hover: #6ee7b7; --accent-soft: #064e3b; --accent-text: #a7f3d0;
    }

    /* VIOLET */
    .palette-violet {
      --bg-0: #faf9fc; --bg-1: #ffffff; --bg-2: #f3f1f8; --bg-3: #e8e4f2;
      --border: #ddd6eb; --border-subtle: #e8e4f2;
      --text-1: #1a1721; --text-2: #46404f; --text-3: #867e94; --text-4: #b3aac2;
      --accent: #7c3aed; --accent-hover: #6d28d9; --accent-soft: #ede9fe; --accent-text: #5b21b6;
    }
    .dark.palette-violet {
      --bg-0: #0c0a12; --bg-1: #17141f; --bg-2: #231e2e; --bg-3: #302940;
      --border: #302940; --border-subtle: #231e2e;
      --text-1: #f3f1f8; --text-2: #b8b0c8; --text-3: #6e6483; --text-4: #453d57;
      --accent: #a78bfa; --accent-hover: #c4b5fd; --accent-soft: #4c1d95; --accent-text: #ddd6fe;
    }

    body { background: var(--bg-0); color: var(--text-2); font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11'; -webkit-font-smoothing: antialiased; }

    .text-display { font-size: 26px; font-weight: 600; letter-spacing: -0.02em; }
    .text-title { font-size: 16px; font-weight: 600; letter-spacing: -0.01em; }
    .text-heading { font-size: 13px; font-weight: 600; }
    .text-body { font-size: 13px; font-weight: 450; }
    .text-label { font-size: 13px; font-weight: 500; }
    .text-caption { font-size: 12px; font-weight: 450; }
    .text-micro { font-size: 10px; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; }

    .text-primary { color: var(--text-1); }
    .text-secondary { color: var(--text-2); }
    .text-muted { color: var(--text-3); }
    .text-faint { color: var(--text-4); }
    .text-accent { color: var(--accent); }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-error { color: var(--error); }

    .nav-item { transition: all 0.1s ease; border-radius: var(--radius-md); }
    .nav-item:hover { background: var(--bg-2); }
    .nav-item.active { background: var(--accent-soft); color: var(--accent); }

    .card { background: var(--bg-1); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); }
    .card-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .card-body { padding: 16px; }
    .card-footer { padding: 8px 16px; border-top: 1px solid var(--border-subtle); background: var(--bg-2); }

    .row { transition: background 0.1s ease; }
    .row:hover { background: var(--bg-2); }
    .row-clickable { cursor: pointer; }

    .btn { border-radius: var(--radius-sm); transition: all 0.1s ease; border: none; cursor: pointer; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--bg-2); color: var(--text-2); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-3); }
    .btn-ghost { background: transparent; }
    .btn-ghost:hover { background: var(--bg-2); }
    .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }

    .icon-box { width: 32px; height: 32px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: var(--accent-soft); flex-shrink: 0; }
    .icon-box i { color: var(--accent); }
    .icon-box-sm { width: 24px; height: 24px; }
    .icon-box-sm i { width: 14px; height: 14px; }

    .icon-action { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
    .icon-action i { color: var(--accent); }

    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

    .kbd { font-family: var(--font-mono); font-size: 10px; padding: 2px 5px; background: var(--bg-2); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-3); }

    .spark { display: flex; align-items: end; gap: 2px; height: 24px; }
    .spark-bar { width: 4px; background: var(--accent); border-radius: 2px; opacity: 0.7; }

    .progress { width: 100%; height: 6px; background: var(--bg-3); border-radius: var(--radius-sm); overflow: hidden; }
    .progress-bar { height: 100%; background: var(--accent); border-radius: var(--radius-sm); }

    .badge { display: inline-flex; align-items: center; justify-content: center; min-width: 18px; height: 18px; padding: 0 6px; border-radius: 9px; font-size: 10px; font-weight: 600; }
    .badge-success { background: var(--success); color: white; }
    .badge-warning { background: var(--warning); color: white; }
    .badge-error { background: var(--error); color: white; }
    .badge-muted { background: var(--bg-3); color: var(--text-3); }

    .status-dot { width: 6px; height: 6px; border-radius: 3px; flex-shrink: 0; }
    .status-dot-success { background: var(--success); }
    .status-dot-warning { background: var(--warning); }
    .status-dot-error { background: var(--error); }

    .input { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-2); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); }
    .input:focus-within { border-color: var(--accent); }
    .input input { flex: 1; background: transparent; border: none; outline: none; color: var(--text-2); }
    .input input::placeholder { color: var(--text-4); }

    /* Toolbar: search + buttons */
    .toolbar-search { height: 32px; padding: 0 10px; gap: 8px; flex: 1; max-width: 240px; }
    .toolbar-search input { font-size: 13px; }
    .toolbar-btn { height: 32px; width: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }

    .pill { padding: 6px 12px; border-radius: var(--radius-md); font-size: 12px; font-weight: 500; background: var(--bg-2); color: var(--text-2); cursor: pointer; transition: all 0.15s ease; border: none; }
    .pill:hover { background: var(--bg-3); }
    .pill.active { background: var(--accent); color: white; }

    .swatch { width: 24px; height: 24px; border-radius: var(--radius-md); cursor: pointer; border: 2px solid transparent; transition: all 0.15s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .swatch:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .swatch.active { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-soft); }

    .menu-toggle { cursor: pointer; }
    .menu-toggle .chevron { transition: transform 0.15s ease; }
    .menu-toggle.open .chevron { transform: rotate(90deg); }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.2s ease; }
    .submenu.open { max-height: 200px; }

    /* Accordion controls */
    .chevron { transition: transform 0.15s ease; }
    .chevron.open { transform: rotate(90deg); }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      flex: 0 0 auto;
      transition: max-height 0.3s ease, opacity 0.2s ease;
    }
    .accordion-content.open {
      max-height: 5000px;
      opacity: 1;
      overflow: visible;
      flex: 1 1 auto;
    }

    /* Grid gap fix removed - no longer needed with panel-based layout */

    .scroll-panel { overflow-y: auto; overflow-x: hidden; }
    .scroll-panel::-webkit-scrollbar { width: 6px; }
    .scroll-panel::-webkit-scrollbar-track { background: transparent; }
    .scroll-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .scroll-panel::-webkit-scrollbar-thumb:hover { background: var(--text-4); }

    .sidebar { width: var(--sidebar-width); transition: width 0.2s ease; }
    .sidebar.collapsed { width: var(--sidebar-collapsed); }
    .sidebar.collapsed .sidebar-text { display: none; }
    .sidebar.collapsed .sidebar-logo-text { display: none; }
    .sidebar.collapsed .sidebar-search { display: none; }
    .sidebar.collapsed .menu-section { display: none; }
    .sidebar.collapsed .nav-item { justify-content: center; padding-left: 0; padding-right: 0; }
    .sidebar.collapsed .nav-badge { display: none; }

    .modal-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .modal { background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: 0 24px 48px rgba(0,0,0,0.2); }
    .dark .modal { box-shadow: 0 24px 48px rgba(0,0,0,0.5); }

    .dropdown { background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
    .dark .dropdown { box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .dropdown-item { transition: background 0.1s ease; }
    .dropdown-item:hover { background: var(--bg-2); }

    .avatar-icon { width: 28px; height: 28px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: var(--accent-soft); }
    .avatar-icon i { color: var(--accent); }

    .settings-panel { background: var(--bg-1); border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08); border-radius: var(--radius-xl); user-select: none; }
    .dark .settings-panel { box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.2); }
    .settings-handle { cursor: grab; padding: 8px 12px; border-radius: var(--radius-xl) var(--radius-xl) 0 0; background: var(--bg-2); border-bottom: 1px solid var(--border-subtle); }
    .settings-handle:active { cursor: grabbing; }
    .settings-handle .grip { width: 32px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto; }

    .btn-google { background: white; border: 1px solid #dadce0; color: #3c4043; }
    .btn-google:hover { background: #f8f9fa; border-color: #dadce0; }
    .dark .btn-google { background: #131314; border-color: #5f6368; color: #e3e3e3; }
    .dark .btn-google:hover { background: #1f1f1f; }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; }

    /* ============================================
       MOBILE RESPONSIVENESS
       ============================================ */

    /* Sidebar overlay backdrop for mobile */
    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 40;
    }
    .sidebar-backdrop.active {
      display: block;
    }

    /* Hamburger button (hidden on desktop) */
    .hamburger-btn {
      display: none;
      width: 40px;
      height: 40px;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    .hamburger-btn:hover {
      background: var(--bg-2);
    }

    /* Mobile breakpoint: tablets and smaller (< 1024px) */
    @media (max-width: 1023px) {
      /* Show hamburger menu */
      .hamburger-btn {
        display: flex;
      }

      /* Hide sidebar by default on mobile */
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        box-shadow: 0 0 0 rgba(0,0,0,0);
      }

      /* Show sidebar when active */
      #sidebar.mobile-open {
        transform: translateX(0);
        box-shadow: 8px 0 24px rgba(0,0,0,0.15);
      }

      /* Dark mode shadow */
      .dark #sidebar.mobile-open {
        box-shadow: 8px 0 24px rgba(0,0,0,0.5);
      }

      /* Main content takes full width */
      main {
        width: 100% !important;
      }

      /* Settings panel: smaller on tablet */
      #settingsPanel {
        max-width: 90vw;
        left: 5vw !important;
        transform: none !important;
      }

      /* Command palette: smaller */
      #command-palette {
        width: 90vw;
        max-width: 500px;
      }

      /* Modals: slightly smaller padding */
      .modal {
        max-width: 90vw;
      }
    }

    /* Mobile breakpoint: phones (< 768px) */
    @media (max-width: 767px) {
      /* Touch-friendly minimum sizes (44px) */
      .btn, .btn-icon, .nav-item {
        min-height: 44px;
        min-width: 44px;
      }

      /* Larger tap targets for icons */
      .icon-action {
        width: 44px;
        height: 44px;
      }

      /* Header adjustments */
      header {
        padding-left: 12px !important;
        padding-right: 12px !important;
      }

      /* Breadcrumb: smaller text */
      #breadcrumb {
        font-size: 12px;
      }
      #breadcrumb .text-label {
        font-size: 12px;
      }

      /* Footer: stack or hide non-essential items */
      footer {
        flex-wrap: wrap;
        gap: 8px;
        padding-top: 8px !important;
        padding-bottom: 8px !important;
        height: auto !important;
      }
      footer > div {
        flex-wrap: wrap;
        gap: 6px;
      }

      /* Edge-to-edge panels on mobile */
      #page-content {
        padding: 8px 0 !important; /* Override p-5, only vertical padding */
      }

      /* Cards: edge-to-edge, no rounded corners */
      .card {
        border-radius: 0;
      }

      /* Panel cards: remove side borders for flush edges */
      .panel-group-card.card {
        border-left: none;
        border-right: none;
      }

      /* Modals: full screen on mobile */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        max-width: 100vw;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }

      /* Command palette: full screen */
      #command-palette {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        width: 100vw;
        transform: none;
      }
      #command-palette .modal {
        border-radius: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #command-results {
        flex: 1;
        max-height: none;
      }

      /* Settings panel: full width at bottom */
      #settingsPanel {
        position: fixed !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        top: auto !important;
        transform: none !important;
        width: 100vw !important;
        max-width: 100vw !important;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0 !important;
      }
      #settingsPanel .p-4 {
        flex-direction: column;
        gap: 16px;
      }
      #settingsPanel .w-px {
        display: none;
      }

      /* Tables: horizontal scroll */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table {
        min-width: 600px;
      }

      /* Dropdowns: adjust positioning */
      #userDropdown,
      #notificationsDropdown {
        position: fixed !important;
        right: 8px !important;
        left: 8px !important;
        top: auto !important;
        bottom: 8px !important;
        width: auto !important;
        max-width: none !important;
      }

      /* User button: compact */
      #userBtn {
        padding: 6px 8px !important;
      }
      #userBtn .text-label {
        display: none;
      }
      #userBtn .text-micro {
        display: none;
      }

      /* Notification button */
      #notificationsBtn {
        min-width: 44px;
      }
    }

    /* Extra small phones (< 375px) */
    @media (max-width: 374px) {
      /* Even more compact */
      .text-display {
        font-size: 20px;
      }
      .text-title {
        font-size: 14px;
      }
      .card-body {
        padding: 12px;
      }
      #page-content {
        padding: 12px !important;
      }
    }

    /* Tablet landscape (768px - 1023px) */
    @media (min-width: 768px) and (max-width: 1023px) {
      /* Content padding: medium */
      #page-content {
        padding: 24px !important;
      }

      /* Sidebar: slightly narrower */
      #sidebar {
        width: 200px;
      }
      #sidebar.collapsed {
        width: var(--sidebar-collapsed);
      }
    }

    /* Utility: hide on mobile */
    @media (max-width: 767px) {
      .hide-mobile {
        display: none !important;
      }
    }

    /* Utility: show only on mobile */
    .show-mobile {
      display: none !important;
    }
    @media (max-width: 767px) {
      .show-mobile {
        display: block !important;
      }
      .toolbar-search {
        max-width: 100% !important;
        height: 44px;
        padding: 0 12px;
      }
      .toolbar-search input {
        font-size: 16px;
      }
      .toolbar-btn {
        height: 44px;
        width: 44px;
      }
    }

    /* ============================================
       DESIGN SYSTEM: Panel-Based Layout
       ============================================ */

    /* Content Container: Fixed-width, centered */
    .design-system-page {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-container {
      flex: 1;
      overflow: hidden;
      display: flex;
      justify-content: center;
      background: var(--bg-0);
    }

    .content-scroll {
      width: 100%;
      max-width: 1280px;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
    }

    @media (max-width: 1023px) {
      .content-scroll {
        padding: 16px;
      }
    }

    /* Mobile: edge-to-edge content (must come after 1023px rule) */
    @media (max-width: 767px) {
      .content-scroll {
        padding: 0;
      }
    }

    /* Page Header */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    @media (max-width: 1023px) {
      .page-header {
        margin-bottom: 16px;
      }
    }

    @media (max-width: 767px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
        padding-bottom: 12px;
      }
    }

    /* Panel Group: Accordion-style cards */
    .panel-group {
      margin-bottom: 12px;
    }

    /* Tighter spacing on mobile, almost no gap when collapsed */
    @media (max-width: 1023px) {
      .panel-group {
        margin-bottom: 4px;
      }

      /* Add spacing back when expanded */
      .panel-group:not(.collapsed) {
        margin-bottom: 12px;
      }
    }

    .panel-group-card {
      overflow: hidden;
    }

    .panel-group-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
      transition: border-color 0.15s ease;
    }

    .panel-group.collapsed .panel-group-header {
      border-bottom: none;
    }

    .collapse-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    .collapse-toggle:hover {
      opacity: 0.7;
    }

    .collapse-toggle .chevron {
      color: var(--text-3);
      flex-shrink: 0;
    }

    .panel-group:not(.collapsed) .chevron {
      transform: rotate(90deg);
    }

    /* Panel body: immediate collapse */
    .panel-group-body {
      max-height: 3000px;
      overflow: visible;
      opacity: 1;
      padding: 16px;
    }

    .panel-group.collapsed .panel-group-body {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      padding: 0 16px;
    }

    /* Panel Grid */
    .panel-grid {
      display: grid;
      gap: 16px;
    }

    /* 5-column grid */
    .panel-grid.grid-5 {
      grid-template-columns: repeat(5, 1fr);
    }

    @media (max-width: 1023px) {
      .panel-grid.grid-5 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .panel-grid.grid-5 {
        grid-template-columns: 1fr;
      }
    }

    /* 4-column grid (system status) */
    .panel-grid.grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    @media (max-width: 1023px) {
      .panel-grid.grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .panel-grid.grid-4 {
        grid-template-columns: 1fr;
      }
    }

    /* 3-column grid (metrics) */
    .panel-grid.grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    @media (max-width: 1023px) {
      .panel-grid.grid-3 {
        grid-template-columns: 1fr;
      }
    }

    /* Stat Card: Canonical size */
    .stat-card {
      padding: 16px;
      display: flex;
      flex-direction: column;
      min-height: 120px;
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .stat-card-value {
      margin-bottom: 4px;
    }

    .stat-card-subtitle {
      margin-top: auto;
    }

    /* Metric Panel */
    .metric-panel {
      min-height: 140px;
    }

    /* Activity List */
    .activity-list {
      display: flex;
      flex-direction: column;
      margin: -16px;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.1s ease;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-item:hover {
      background: var(--bg-2);
    }

    .activity-icon {
      flex-shrink: 0;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-time {
      flex-shrink: 0;
    }

    /* Side Panel (extraneous content) */
    .side-panel {
      display: none;
      margin-top: 24px;
    }

    @media (min-width: 1400px) {
      .side-panel {
        display: block;
      }
    }

    /* Spacing utilities */
    .space-y-2 > * + * {
      margin-top: 8px;
    }
  </style>
</head>
<body class="text-body antialiased">
  <!-- Settings Panel -->
  <div id="settingsPanel" class="settings-panel fixed hidden" style="z-index: 1100; bottom: 20px; left: 50%; transform: translateX(-50%);">
    <div class="settings-handle" id="settings-drag-handle">
      <div class="grip"></div>
    </div>
    <div class="p-4 flex items-center gap-6">
      <div class="flex items-center gap-3">
        <span class="text-micro" style="color:var(--text-3)">Theme</span>
        <div class="flex gap-1">
          <button class="pill theme-btn active" data-theme="light">
            <i data-lucide="sun" class="w-3.5 h-3.5 inline-block mr-1" style="vertical-align: -2px"></i>Light
          </button>
          <button class="pill theme-btn" data-theme="dark">
            <i data-lucide="moon" class="w-3.5 h-3.5 inline-block mr-1" style="vertical-align: -2px"></i>Dark
          </button>
        </div>
      </div>
      <div class="w-px h-6" style="background:var(--border)"></div>
      <div class="flex items-center gap-3">
        <span class="text-micro" style="color:var(--text-3)">Palette</span>
        <div class="flex gap-2">
          <div class="swatch active" data-palette="stone" title="Stone" style="background: linear-gradient(135deg, #faf9f7 50%, #d97706 50%)"></div>
          <div class="swatch" data-palette="slate" title="Slate" style="background: linear-gradient(135deg, #f8fafc 50%, #0284c7 50%)"></div>
          <div class="swatch" data-palette="oxide" title="Oxide" style="background: linear-gradient(135deg, #faf8f8 50%, #e11d48 50%)"></div>
          <div class="swatch" data-palette="forest" title="Forest" style="background: linear-gradient(135deg, #f7faf8 50%, #059669 50%)"></div>
          <div class="swatch" data-palette="violet" title="Violet" style="background: linear-gradient(135deg, #faf9fc 50%, #7c3aed 50%)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Command Palette Modal -->
  <div id="command-backdrop" class="fixed inset-0 z-50 hidden modal-backdrop"></div>
  <div id="command-palette" class="fixed z-50 hidden" style="top: 20%; left: 50%; transform: translateX(-50%); width: 500px;">
    <div class="modal p-0 overflow-hidden">
      <div class="p-3 border-b" style="border-color: var(--border)">
        <input id="command-input" type="text" placeholder="Type a command..." class="w-full bg-transparent outline-none text-body" style="color: var(--text-1)">
      </div>
      <div id="command-results" class="max-h-80 overflow-auto scroll-panel"></div>
    </div>
  </div>

  <!-- Sign In Modal -->
  <div id="signInModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="modal w-full max-w-sm p-6 relative">
      <div class="text-center mb-6">
        <div class="w-12 h-12 mx-auto mb-4 flex items-center justify-center" style="background:var(--accent);border-radius:var(--radius-md)">
          <i data-lucide="zap" class="w-6 h-6 text-white"></i>
        </div>
        <h2 class="text-title" style="color:var(--text-1)">Sign in to Fazt</h2>
        <p class="text-caption mt-1" style="color:var(--text-3)">Manage your apps and deployments</p>
      </div>
      <button id="signInGoogle" class="btn-google w-full flex items-center justify-center gap-3 px-4 py-3 text-label font-medium" style="border-radius:var(--radius-md)">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
          <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
          <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z" fill="#34A853"/>
          <path d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
          <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
        </svg>
        Continue with Google
      </button>
      <div class="mt-6 pt-4 border-t text-center" style="border-color:var(--border)">
        <p class="text-caption" style="color:var(--text-4)">By signing in, you agree to our Terms of Service</p>
      </div>
      <button id="closeSignIn" class="absolute top-4 right-4 p-1 btn-ghost" style="color:var(--text-3);border-radius:var(--radius-sm)">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <!-- New App Modal -->
  <div id="newAppModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="modal w-full max-w-md p-6 relative">
      <div class="text-center mb-6">
        <div class="w-12 h-12 mx-auto mb-4 flex items-center justify-center" style="background:var(--accent-soft);border-radius:var(--radius-md)">
          <i data-lucide="rocket" class="w-6 h-6" style="color:var(--accent)"></i>
        </div>
        <h2 class="text-title" style="color:var(--text-1)">Create New App</h2>
        <p class="text-caption mt-1" style="color:var(--text-3)">Create an app from a template</p>
      </div>

      <form id="newAppForm" class="space-y-4 mb-6">
        <!-- App Name -->
        <div>
          <label class="text-micro text-muted block mb-2">APP NAME</label>
          <div class="input">
            <i data-lucide="box" class="w-4 h-4 text-faint"></i>
            <input type="text" id="newAppName" name="name" placeholder="my-app" class="text-body" required pattern="[a-z0-9-]+" title="Lowercase letters, numbers, and dashes only" style="flex: 1">
          </div>
          <div class="text-caption text-muted mt-1 px-1">Lowercase letters, numbers, and dashes only</div>
        </div>

        <!-- Template Selection -->
        <div>
          <label class="text-micro text-muted block mb-2">TEMPLATE</label>
          <div id="templateGrid" class="grid grid-cols-2 gap-2">
            <button type="button" class="template-option p-3 text-left" style="background:var(--bg-2);border:2px solid var(--accent);border-radius:var(--radius-md);cursor:pointer" data-template="minimal">
              <div class="flex items-center gap-2 mb-1">
                <i data-lucide="file" class="w-4 h-4" style="color:var(--accent)"></i>
                <span class="text-label text-primary">Minimal</span>
              </div>
              <div class="text-caption text-muted">Static site</div>
            </button>
            <button type="button" class="template-option p-3 text-left" style="background:var(--bg-2);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer" data-template="spa">
              <div class="flex items-center gap-2 mb-1">
                <i data-lucide="layout" class="w-4 h-4" style="color:var(--text-3)"></i>
                <span class="text-label text-primary">SPA</span>
              </div>
              <div class="text-caption text-muted">With routing</div>
            </button>
            <button type="button" class="template-option p-3 text-left" style="background:var(--bg-2);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer" data-template="api">
              <div class="flex items-center gap-2 mb-1">
                <i data-lucide="code" class="w-4 h-4" style="color:var(--text-3)"></i>
                <span class="text-label text-primary">API</span>
              </div>
              <div class="text-caption text-muted">Serverless only</div>
            </button>
            <button type="button" class="template-option p-3 text-left" style="background:var(--bg-2);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer" data-template="full">
              <div class="flex items-center gap-2 mb-1">
                <i data-lucide="layers" class="w-4 h-4" style="color:var(--text-3)"></i>
                <span class="text-label text-primary">Full Stack</span>
              </div>
              <div class="text-caption text-muted">Static + API</div>
            </button>
          </div>
          <input type="hidden" id="newAppTemplate" name="template" value="minimal">
        </div>

        <!-- Error Message -->
        <div id="newAppError" class="hidden p-3" style="background:var(--error-soft);border-radius:var(--radius-md);border:1px solid var(--error)">
          <div class="flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-4 h-4" style="color:var(--error)"></i>
            <span class="text-caption" style="color:var(--error)" id="newAppErrorText"></span>
          </div>
        </div>
      </form>

      <div class="flex gap-2">
        <button id="closeNewApp" class="btn btn-secondary flex-1 text-label" style="padding:8px 16px">
          Cancel
        </button>
        <button id="submitNewApp" class="btn btn-primary flex-1 text-label" style="padding:8px 16px">
          <span id="submitNewAppText">Create App</span>
          <span id="submitNewAppLoading" class="hidden">Creating...</span>
        </button>
      </div>

      <button id="closeNewAppX" class="absolute top-4 right-4 p-1 btn-ghost" style="color:var(--text-3);border-radius:var(--radius-sm)">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <!-- Create Alias Modal -->
  <div id="createAliasModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="modal w-full max-w-md p-6 relative">
      <div class="text-center mb-6">
        <div class="w-12 h-12 mx-auto mb-4 flex items-center justify-center" style="background:var(--accent-soft);border-radius:var(--radius-md)">
          <i data-lucide="link" class="w-6 h-6" style="color:var(--accent)"></i>
        </div>
        <h2 class="text-title" style="color:var(--text-1)">Create Alias</h2>
        <p class="text-caption mt-1" style="color:var(--text-3)">Point a subdomain to an app or URL</p>
      </div>

      <form id="createAliasForm" class="space-y-4 mb-6">
        <!-- Subdomain -->
        <div>
          <label class="text-micro text-muted block mb-2">SUBDOMAIN</label>
          <div class="input">
            <i data-lucide="at-sign" class="w-4 h-4 text-faint"></i>
            <input type="text" id="aliasSubdomain" name="subdomain" placeholder="my-alias" class="text-body" required pattern="[a-z0-9-]+" style="flex: 1">
          </div>
        </div>

        <!-- Type Selection -->
        <div>
          <label class="text-micro text-muted block mb-2">TYPE</label>
          <div class="flex gap-2">
            <button type="button" class="alias-type-btn flex-1 p-2 text-center" style="background:var(--accent-soft);border:2px solid var(--accent);border-radius:var(--radius-md);cursor:pointer" data-type="proxy">
              <i data-lucide="arrow-right" class="w-4 h-4 mx-auto mb-1" style="color:var(--accent)"></i>
              <div class="text-caption text-primary">Proxy</div>
            </button>
            <button type="button" class="alias-type-btn flex-1 p-2 text-center" style="background:var(--bg-2);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer" data-type="redirect">
              <i data-lucide="external-link" class="w-4 h-4 mx-auto mb-1" style="color:var(--text-3)"></i>
              <div class="text-caption text-primary">Redirect</div>
            </button>
            <button type="button" class="alias-type-btn flex-1 p-2 text-center" style="background:var(--bg-2);border:2px solid var(--border-subtle);border-radius:var(--radius-md);cursor:pointer" data-type="reserved">
              <i data-lucide="lock" class="w-4 h-4 mx-auto mb-1" style="color:var(--text-3)"></i>
              <div class="text-caption text-primary">Reserved</div>
            </button>
          </div>
          <input type="hidden" id="aliasType" name="type" value="proxy">
        </div>

        <!-- Target (for proxy) -->
        <div id="aliasProxyTarget">
          <label class="text-micro text-muted block mb-2">TARGET APP</label>
          <div class="app-select-container" style="position:relative">
            <div id="aliasAppSelect" class="input cursor-pointer" style="justify-content:space-between">
              <span id="aliasAppSelectText" class="text-muted">Select an app...</span>
              <i data-lucide="chevron-down" class="w-4 h-4 text-faint"></i>
            </div>
            <div id="aliasAppDropdown" class="dropdown hidden" style="position:absolute;top:100%;left:0;right:0;margin-top:4px;max-height:240px;overflow:hidden;z-index:100">
              <div class="p-2 border-b" style="border-color:var(--border)">
                <input type="text" id="aliasAppSearch" placeholder="Search apps..." class="w-full p-2 text-body" style="background:var(--bg-2);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);color:var(--text-1)">
              </div>
              <div id="aliasAppList" class="scroll-panel" style="max-height:180px;overflow-y:auto"></div>
            </div>
            <input type="hidden" id="aliasAppId" name="app_id" value="">
          </div>
        </div>

        <!-- Target (for redirect) -->
        <div id="aliasRedirectTarget" class="hidden">
          <label class="text-micro text-muted block mb-2">REDIRECT URL</label>
          <div class="input">
            <i data-lucide="globe" class="w-4 h-4 text-faint"></i>
            <input type="url" id="aliasRedirectUrl" name="redirect_url" placeholder="https://example.com" class="text-body" style="flex: 1">
          </div>
        </div>

        <!-- Error Message -->
        <div id="createAliasError" class="hidden p-3" style="background:var(--error-soft);border-radius:var(--radius-md);border:1px solid var(--error)">
          <div class="flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-4 h-4" style="color:var(--error)"></i>
            <span class="text-caption" style="color:var(--error)" id="createAliasErrorText"></span>
          </div>
        </div>
      </form>

      <div class="flex gap-2">
        <button id="closeCreateAlias" class="btn btn-secondary flex-1 text-label" style="padding:8px 16px">Cancel</button>
        <button id="submitCreateAlias" class="btn btn-primary flex-1 text-label" style="padding:8px 16px">
          <span id="submitCreateAliasText">Create Alias</span>
          <span id="submitCreateAliasLoading" class="hidden">Creating...</span>
        </button>
      </div>

      <button id="closeCreateAliasX" class="absolute top-4 right-4 p-1 btn-ghost" style="color:var(--text-3);border-radius:var(--radius-sm)">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <!-- Edit Alias Modal -->
  <div id="editAliasModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="modal w-full max-w-md p-6 relative">
      <div class="text-center mb-6">
        <div class="w-12 h-12 mx-auto mb-4 flex items-center justify-center" style="background:var(--accent-soft);border-radius:var(--radius-md)">
          <i data-lucide="edit-3" class="w-6 h-6" style="color:var(--accent)"></i>
        </div>
        <h2 class="text-title" style="color:var(--text-1)">Edit Alias</h2>
        <p class="text-caption mt-1" style="color:var(--text-3)" id="editAliasSubtitle">Modify alias settings</p>
      </div>

      <form id="editAliasForm" class="space-y-4 mb-6">
        <input type="hidden" id="editAliasSubdomain" name="subdomain">

        <!-- Type Display (read-only) -->
        <div>
          <label class="text-micro text-muted block mb-2">TYPE</label>
          <div class="p-2 text-body" style="background:var(--bg-2);border-radius:var(--radius-sm);color:var(--text-1)" id="editAliasTypeDisplay">proxy</div>
        </div>

        <!-- Target (for proxy) -->
        <div id="editAliasProxyTarget">
          <label class="text-micro text-muted block mb-2">TARGET APP</label>
          <div class="app-select-container" style="position:relative">
            <div id="editAliasAppSelect" class="input cursor-pointer" style="justify-content:space-between">
              <span id="editAliasAppSelectText" class="text-muted">Select an app...</span>
              <i data-lucide="chevron-down" class="w-4 h-4 text-faint"></i>
            </div>
            <div id="editAliasAppDropdown" class="dropdown hidden" style="position:absolute;top:100%;left:0;right:0;margin-top:4px;max-height:240px;overflow:hidden;z-index:100">
              <div class="p-2 border-b" style="border-color:var(--border)">
                <input type="text" id="editAliasAppSearch" placeholder="Search apps..." class="w-full p-2 text-body" style="background:var(--bg-2);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);color:var(--text-1)">
              </div>
              <div id="editAliasAppList" class="scroll-panel" style="max-height:180px;overflow-y:auto"></div>
            </div>
            <input type="hidden" id="editAliasAppId" name="app_id" value="">
          </div>
        </div>

        <!-- Target (for redirect) -->
        <div id="editAliasRedirectTarget" class="hidden">
          <label class="text-micro text-muted block mb-2">REDIRECT URL</label>
          <div class="input">
            <i data-lucide="globe" class="w-4 h-4 text-faint"></i>
            <input type="url" id="editAliasRedirectUrl" name="redirect_url" placeholder="https://example.com" class="text-body" style="flex: 1">
          </div>
        </div>

        <!-- Error Message -->
        <div id="editAliasError" class="hidden p-3" style="background:var(--error-soft);border-radius:var(--radius-md);border:1px solid var(--error)">
          <div class="flex items-center gap-2">
            <i data-lucide="alert-circle" class="w-4 h-4" style="color:var(--error)"></i>
            <span class="text-caption" style="color:var(--error)" id="editAliasErrorText"></span>
          </div>
        </div>
      </form>

      <div class="flex gap-2">
        <button id="deleteAlias" class="btn btn-secondary text-label" style="padding:8px 16px;color:var(--error)">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
        <button id="closeEditAlias" class="btn btn-secondary flex-1 text-label" style="padding:8px 16px">Cancel</button>
        <button id="submitEditAlias" class="btn btn-primary flex-1 text-label" style="padding:8px 16px">
          <span id="submitEditAliasText">Save Changes</span>
          <span id="submitEditAliasLoading" class="hidden">Saving...</span>
        </button>
      </div>

      <button id="closeEditAliasX" class="absolute top-4 right-4 p-1 btn-ghost" style="color:var(--text-3);border-radius:var(--radius-sm)">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <!-- Notifications Dropdown -->
  <div id="notificationsDropdown" class="dropdown fixed z-50 hidden w-80" style="top:56px;right:60px">
    <div class="px-4 py-3 border-b flex items-center justify-between" style="border-color:var(--border)">
      <span class="text-heading" style="color:var(--text-1)">Notifications</span>
      <button class="text-caption" style="color:var(--accent)">Mark all read</button>
    </div>
    <div class="max-h-80 overflow-auto scroll-panel">
      <div class="px-4 py-3 flex items-start gap-3 dropdown-item cursor-pointer" style="background:var(--accent-soft)">
        <div class="icon-box flex-shrink-0 mt-0.5"><i data-lucide="check-circle" class="w-4 h-4"></i></div>
        <div class="flex-1 min-w-0">
          <div class="text-label" style="color:var(--text-1)">momentum deployed</div>
          <div class="text-caption" style="color:var(--text-3)">Successfully deployed v1.4.2</div>
          <div class="text-caption mt-1" style="color:var(--text-4)">2h ago</div>
        </div>
        <div class="w-2 h-2 rounded-full flex-shrink-0 mt-2" style="background:var(--accent)"></div>
      </div>
      <div class="px-4 py-3 flex items-start gap-3 dropdown-item cursor-pointer">
        <div class="icon-box flex-shrink-0 mt-0.5"><i data-lucide="settings" class="w-4 h-4"></i></div>
        <div class="flex-1 min-w-0">
          <div class="text-label" style="color:var(--text-1)">Config updated</div>
          <div class="text-caption" style="color:var(--text-3)">Rate limits changed</div>
          <div class="text-caption mt-1" style="color:var(--text-4)">5h ago</div>
        </div>
      </div>
    </div>
    <div class="px-4 py-3 border-t" style="border-color:var(--border)">
      <button class="w-full text-center text-caption font-medium" style="color:var(--accent)">View all activity</button>
    </div>
  </div>

  <!-- User Dropdown -->
  <div id="userDropdown" class="dropdown fixed z-50 hidden w-64" style="top:56px;right:16px"></div>

  <!-- Sidebar Backdrop (mobile only) -->
  <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

  <!-- App Shell -->
  <div class="flex flex-col h-screen overflow-hidden">
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <aside id="sidebar" class="sidebar flex flex-col border-r overflow-hidden" style="background:var(--bg-1);border-color:var(--border)">
        <!-- Logo -->
        <div class="flex items-center gap-2.5 px-4 h-12 border-b flex-shrink-0" style="border-color:var(--border)">
          <button id="sidebar-toggle" class="w-6 h-6 flex items-center justify-center btn-ghost" style="border-radius:var(--radius-sm)">
            <i data-lucide="panel-left" class="w-4 h-4" style="color:var(--text-3)"></i>
          </button>
          <div class="sidebar-logo-text flex items-center gap-2 flex-1">
            <div class="w-6 h-6 flex items-center justify-center" style="background:var(--accent);border-radius:var(--radius-sm)">
              <i data-lucide="zap" class="w-3.5 h-3.5 text-white"></i>
            </div>
            <span class="text-heading" style="color:var(--text-1)">fazt</span>
            <span class="text-caption mono ml-auto" style="color:var(--text-4)">0.17</span>
          </div>
        </div>

        <!-- Search -->
        <div class="sidebar-search px-3 py-2.5 border-b flex-shrink-0" style="border-color:var(--border)">
          <button id="openCommandPalette" class="w-full flex items-center gap-2 px-2.5 py-1.5 text-label border" style="background:var(--bg-2);border-color:var(--border-subtle);color:var(--text-3);border-radius:var(--radius-sm)">
            <i data-lucide="search" class="w-4 h-4"></i>
            <span class="sidebar-text">Search...</span>
            <span class="ml-auto kbd sidebar-text">&#x2318;K</span>
          </button>
        </div>

        <!-- Nav -->
        <nav class="flex-1 p-2 space-y-0.5 scroll-panel">
          <a href="/" class="nav-item flex items-center gap-2.5 px-3 py-2 text-label" data-route="dashboard">
            <i data-lucide="layout-grid" class="w-4 h-4"></i>
            <span class="sidebar-text">Dashboard</span>
          </a>

          <div class="menu-section pt-4 pb-1">
            <div class="menu-toggle open flex items-center gap-1 px-3">
              <i data-lucide="chevron-right" class="w-3 h-3 chevron" style="color:var(--text-4)"></i>
              <span class="text-micro" style="color:var(--text-4)">Resources</span>
            </div>
          </div>
          <div class="submenu open space-y-0.5">
            <a href="/apps" class="nav-item flex items-center gap-2.5 px-3 py-2 text-label" data-route="apps">
              <i data-lucide="layers" class="w-4 h-4"></i>
              <span class="sidebar-text">Apps</span>
              <span class="nav-badge ml-auto text-caption mono px-1.5 py-0.5" style="background:var(--bg-2);color:var(--text-3);border-radius:var(--radius-sm)" id="apps-count">0</span>
            </a>
            <a href="/aliases" class="nav-item flex items-center gap-2.5 px-3 py-2 text-label" data-route="aliases">
              <i data-lucide="link" class="w-4 h-4"></i>
              <span class="sidebar-text">Aliases</span>
            </a>
          </div>

          <div class="menu-section pt-4 pb-1">
            <div class="menu-toggle open flex items-center gap-1 px-3">
              <i data-lucide="chevron-right" class="w-3 h-3 chevron" style="color:var(--text-4)"></i>
              <span class="text-micro" style="color:var(--text-4)">Observability</span>
            </div>
          </div>
          <div class="submenu open space-y-0.5">
            <a href="/events" class="nav-item flex items-center gap-2.5 px-3 py-2 text-label" data-route="events">
              <i data-lucide="activity" class="w-4 h-4"></i>
              <span class="sidebar-text">Events</span>
            </a>
            <a href="/logs" class="nav-item flex items-center gap-2.5 px-3 py-2 text-label" data-route="logs">
              <i data-lucide="terminal" class="w-4 h-4"></i>
              <span class="sidebar-text">Logs</span>
            </a>
          </div>

          <div class="menu-section pt-4 pb-1">
            <div class="menu-toggle open flex items-center gap-1 px-3">
              <i data-lucide="chevron-right" class="w-3 h-3 chevron" style="color:var(--text-4)"></i>
              <span class="text-micro" style="color:var(--text-4)">System</span>
            </div>
          </div>
          <div class="submenu open space-y-0.5">
            <a href="/system" class="nav-item flex items-center gap-2.5 px-3 py-2 text-label" data-route="system">
              <i data-lucide="heart-pulse" class="w-4 h-4"></i>
              <span class="sidebar-text">Health</span>
              <span class="nav-badge ml-auto w-2 h-2 pulse" style="background:var(--success);border-radius:var(--radius-sm)"></span>
            </a>
            <a href="/settings" class="nav-item flex items-center gap-2.5 px-3 py-2 text-label" data-route="settings">
              <i data-lucide="settings" class="w-4 h-4"></i>
              <span class="sidebar-text">Settings</span>
            </a>
          </div>
        </nav>
      </aside>

      <!-- Main -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="flex items-center justify-between px-5 h-12 border-b flex-shrink-0" style="background:var(--bg-1);border-color:var(--border)">
          <div class="flex items-center gap-3">
            <button id="mobile-menu-btn" class="hamburger-btn">
              <i data-lucide="menu" class="w-5 h-5" style="color:var(--text-2)"></i>
            </button>
            <div id="breadcrumb" class="flex items-center gap-2 text-label">
              <span style="color:var(--text-3)">Home</span>
              <i data-lucide="chevron-right" class="w-3 h-3" style="color:var(--text-4)"></i>
              <span style="color:var(--text-1)">Dashboard</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="notificationsBtn" class="btn btn-ghost relative p-2" style="color:var(--text-2)">
              <i data-lucide="bell" class="w-4 h-4"></i>
              <span class="badge absolute -top-0.5 -right-0.5 flex items-center justify-center" style="background:var(--error);color:white">2</span>
            </button>
            <div id="userContainer"></div>
          </div>
        </header>

        <!-- Content -->
        <div id="page-content" class="flex-1 overflow-hidden p-5">
          <div class="flex items-center justify-center h-full">
            <div class="text-caption text-muted">Loading...</div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="px-3 py-2 border-t flex items-center justify-between flex-shrink-0" style="background:var(--bg-1);border-color:var(--border);height:var(--footer-height)">
          <div class="flex items-center gap-2 text-caption" style="color:var(--text-4)">
            <span class="mono text-xs">v0.17.0</span>
            <span class="w-1.5 h-1.5 hide-mobile" style="background:var(--success);border-radius:2px"></span>
            <span class="w-1.5 h-1.5 show-mobile" style="background:var(--success);border-radius:2px"></span>
          </div>
          <div class="flex items-center gap-1 text-caption" style="color:var(--text-4)">
            <button id="toggleMock" class="btn-icon btn-ghost" title="Toggle mock data mode" style="border-radius:var(--radius-sm);width:28px;height:28px">
              <i data-lucide="database" class="w-3.5 h-3.5"></i>
            </button>
            <button id="toggleSettingsPanel" class="btn-icon btn-ghost" title="Toggle theme panel" style="border-radius:var(--radius-sm);width:28px;height:28px">
              <i data-lucide="palette" class="w-3.5 h-3.5"></i>
            </button>
            <a href="#" class="btn-icon btn-ghost" title="Documentation" style="border-radius:var(--radius-sm);width:28px;height:28px;display:flex;align-items:center;justify-content:center">
              <i data-lucide="book-open" class="w-3.5 h-3.5"></i>
            </a>
            <a href="#" class="btn-icon btn-ghost" title="API Reference" style="border-radius:var(--radius-sm);width:28px;height:28px;display:flex;align-items:center;justify-content:center">
              <i data-lucide="code" class="w-3.5 h-3.5"></i>
            </a>
          </div>
        </footer>
      </main>
    </div>
  </div>

  <script type="module">
    import { createRouter, createCommands, createAgentContext } from './packages/zap/index.js'
    import { createClient, mockAdapter } from './packages/fazt-sdk/index.js'
    import { routes } from './src/routes.js'
    import { initTheme, sidebarCollapsed, toggleSidebar, theme, palette, setTheme, setPalette } from './src/stores/app.js'
    import { loadApps, loadAliases, loadHealth, loadStats, apps, aliases, auth, loadAuth, signOut, currentApp, createApp, createAlias, updateAlias, deleteAlias } from './src/stores/data.js'

    // Pages
    import * as dashboardPage from './src/pages/dashboard.js'
    import * as appsPage from './src/pages/apps.js'
    import * as aliasesPage from './src/pages/aliases.js'
    import * as eventsPage from './src/pages/events.js'
    import * as logsPage from './src/pages/logs.js'
    import * as systemPage from './src/pages/system.js'
    import * as settingsPage from './src/pages/settings.js'

    const pages = {
      dashboard: dashboardPage,
      apps: appsPage,
      'app-detail': appsPage,
      aliases: aliasesPage,
      events: eventsPage,
      logs: logsPage,
      system: systemPage,
      settings: settingsPage
    }

    // Use mock adapter for dev
    const useMock = new URLSearchParams(window.location.search).get('mock') === 'true'

    // Compute API base URL - admin UI may be served from different subdomain than API
    // API always lives on admin.* subdomain
    function getApiBaseUrl() {
      const hostname = window.location.hostname
      const port = window.location.port ? ':' + window.location.port : ''
      const protocol = window.location.protocol
      // Replace any subdomain with 'admin' to get API URL
      const parts = hostname.split('.')
      if (parts.length >= 2) {
        parts[0] = 'admin'
        return `${protocol}//${parts.join('.')}${port}`
      }
      return '' // Fallback: same origin
    }

    const apiBaseUrl = useMock ? '' : getApiBaseUrl()
    const client = createClient(useMock ? { adapter: mockAdapter } : { baseUrl: apiBaseUrl })

    console.log('[Admin] Mode:', useMock ? 'MOCK' : 'REAL')
    console.log('[Admin] API Base:', apiBaseUrl || '(same origin)')

    // State (declared early so callbacks can reference them)
    let pageContainer = null
    let currentCleanup = null

    // Router (history mode + fazt SPA mode = clean URLs)
    const router = createRouter({
      mode: 'history',
      routes,
      onNavigate: (match) => {
        renderPage(match)
        updateBreadcrumb(match)
        updateNav(match)
      }
    })

    // Commands
    const commands = createCommands()
    commands.registerAll([
      { id: 'dashboard', title: 'Go to Dashboard', shortcut: 'G H', icon: 'layout-grid', action: () => router.push('/') },
      { id: 'apps', title: 'Go to Apps', shortcut: 'G A', icon: 'layers', action: () => router.push('/apps') },
      { id: 'aliases', title: 'Go to Aliases', shortcut: 'G L', icon: 'link', action: () => router.push('/aliases') },
      { id: 'system', title: 'Go to System', shortcut: 'G S', icon: 'heart-pulse', action: () => router.push('/system') },
      { id: 'settings', title: 'Go to Settings', shortcut: 'G ,', icon: 'settings', action: () => router.push('/settings') },
      { id: 'theme-light', title: 'Switch to Light Theme', icon: 'sun', action: () => setTheme('light') },
      { id: 'theme-dark', title: 'Switch to Dark Theme', icon: 'moon', action: () => setTheme('dark') },
      { id: 'refresh', title: 'Refresh Data', shortcut: 'R', icon: 'refresh-cw', action: loadData }
    ])

    createAgentContext(router, commands, { theme, palette, sidebarCollapsed })

    async function loadData() {
      await Promise.all([
        loadApps(client),
        loadAliases(client),
        loadHealth(client),
        loadStats(client)
      ])
      // Update apps count in sidebar
      const appsCount = document.getElementById('apps-count')
      if (appsCount) appsCount.textContent = apps.get().length
    }

    function renderPage(match) {
      if (!pageContainer) return
      if (currentCleanup) {
        currentCleanup()
        currentCleanup = null
      }
      const page = pages[match.route.name]
      if (page?.render) {
        currentCleanup = page.render(pageContainer, {
          router,
          client,
          commands,
          params: match.params,
          refresh: loadData
        })
      } else {
        pageContainer.innerHTML = `
          <div class="flex items-center justify-center h-full">
            <div class="text-center">
              <i data-lucide="alert-circle" class="w-12 h-12 text-faint mx-auto mb-2"></i>
              <div class="text-heading text-primary mb-1">Page Not Found</div>
              <div class="text-caption text-muted">The page you're looking for doesn't exist.</div>
              <button class="btn btn-primary mt-4" onclick="window.location.hash='/'">Go to Dashboard</button>
            </div>
          </div>
        `
        lucide.createIcons()
      }
    }

    function updateBreadcrumb(match) {
      const breadcrumb = document.getElementById('breadcrumb')
      if (!breadcrumb) return
      const route = match.route
      const parent = route.meta?.parent ? routes.find(r => r.name === route.meta.parent) : null

      // For app detail pages, get the app name
      let displayTitle = route.meta?.title || route.name
      if (route.name === 'app-detail' && match.params?.id) {
        const app = currentApp.get()
        if (app?.name) {
          displayTitle = app.name
        }
      }

      breadcrumb.innerHTML = `
        <span style="color:var(--text-3)">Home</span>
        <i data-lucide="chevron-right" class="w-3 h-3" style="color:var(--text-4)"></i>
        ${parent ? `
          <a href="${parent.path}" class="breadcrumb-link" style="color:var(--text-3);cursor:pointer">${parent.meta?.title || parent.name}</a>
          <i data-lucide="chevron-right" class="w-3 h-3" style="color:var(--text-4)"></i>
        ` : ''}
        <span style="color:var(--text-1)">${displayTitle}</span>
      `
      lucide.createIcons()

      // Add click handler for parent link
      breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault()
          router.push(link.getAttribute('href'))
        })
      })
    }

    function updateNav(match) {
      document.querySelectorAll('.nav-item[data-route]').forEach(item => {
        // Only highlight exact route match, not parents
        const isActive = item.dataset.route === match.route.name
        item.classList.toggle('active', isActive)
      })
    }

    // Show unauthorized modal
    // NOTE: This is UX only - real security is enforced on backend via AdminMiddleware
    // Backend returns 403 Forbidden for all /api/* requests from users without admin/owner role
    function showUnauthorizedModal(user) {
      const userName = user.name || user.email || 'User'
      const userRole = user.role || 'user'

      // Create modal HTML
      const modalHTML = `
        <div id="unauthorized-modal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 9999;">
          <div style="background: var(--bg-1); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); max-width: 28rem; width: 100%; margin: 1rem; padding: 1.5rem;">
            <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
              <div style="flex-shrink: 0; width: 3rem; height: 3rem; border-radius: 50%; background: var(--error-soft); display: flex; align-items: center; justify-content: center;">
                <svg style="width: 1.5rem; height: 1.5rem; color: var(--error);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <div style="flex: 1;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-1); margin-bottom: 0.5rem;">Access Denied</h3>
                <p style="font-size: 0.875rem; color: var(--text-2); margin-bottom: 0.75rem;">
                  Sorry, <strong>${userName}</strong> (<code style="background: var(--bg-2); padding: 0.125rem 0.375rem; border-radius: 0.25rem;">${userRole}</code> role), you don't have permission to access the admin dashboard.
                </p>
                <p style="font-size: 0.875rem; color: var(--text-3);">
                  Admin access requires <strong>admin</strong> or <strong>owner</strong> role.
                </p>
              </div>
            </div>
            <div style="margin-top: 1.5rem;">
              <button id="unauthorized-signout" style="width: 100%; padding: 0.5rem 1rem; background: var(--accent); color: white; font-weight: 500; border: none; border-radius: 0.375rem; cursor: pointer; transition: background 0.2s;">
                Sign Out & Try Again
              </button>
            </div>
          </div>
        </div>
      `

      // Insert modal
      document.body.insertAdjacentHTML('beforeend', modalHTML)

      // Setup button
      document.getElementById('unauthorized-signout').addEventListener('click', async () => {
        // Sign out by clearing cookie and redirecting to login
        document.cookie = 'fazt_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
        const authDomain = window.location.hostname.split('.').slice(1).join('.')
        // Include redirect parameter so user returns to admin after re-login
        const currentUrl = window.location.href
        const loginUrl = window.location.protocol + '//' + authDomain + (window.location.port ? ':' + window.location.port : '') + '/auth/login?redirect=' + encodeURIComponent(currentUrl)
        window.location.href = loginUrl
      })
    }

    // Get auth domain (root domain without subdomain)
    function getAuthDomain() {
      const parts = window.location.hostname.split('.')
      // If on subdomain, remove it to get root domain
      if (parts.length > 2 && parts[0] !== 'www') {
        return parts.slice(1).join('.')
      }
      return window.location.hostname
    }

    // Check if user has admin access
    function checkAccess() {
      const authState = auth.get()

      if (authState.loading) return true // Still loading

      // Get current URL without mock parameter (we want real auth)
      const url = new URL(window.location.href)
      url.searchParams.delete('mock') // Remove mock mode for auth redirect
      const currentUrl = url.toString()

      // Not authenticated -> redirect to login with full URL
      if (!authState.authenticated || !authState.user) {
        const authDomain = getAuthDomain()
        const authUrl = `${window.location.protocol}//${authDomain}${window.location.port ? ':' + window.location.port : ''}/auth/login?redirect=${encodeURIComponent(currentUrl)}`
        console.log('[Auth] Redirecting to login:', authUrl)
        window.location.href = authUrl
        return false
      }

      // Check role - admin/owner only
      const user = authState.user
      if (user.role !== 'owner' && user.role !== 'admin') {
        console.log('[Auth] Unauthorized - showing modal for role:', user.role)
        showUnauthorizedModal(user)
        return false
      }

      return true
    }

    // Provider icons
    function getProviderIcon(provider) {
      const icons = {
        google: 'mail',
        github: 'github',
        dev: 'code',
        mock: 'test-tube'
      }
      return icons[provider] || 'shield'
    }

    // Provider display name
    function getProviderName(provider) {
      const names = {
        google: 'Google',
        github: 'GitHub',
        dev: 'Dev Login',
        mock: 'Mock'
      }
      return names[provider] || provider
    }

    // Render user header based on auth state
    function renderUserHeader() {
      const container = document.getElementById('userContainer')
      const authState = auth.get()

      if (authState.loading) {
        container.innerHTML = '<div class="text-caption text-muted">Loading...</div>'
        return
      }

      if (!authState.authenticated || !authState.user) {
        checkAccess()
        return
      }

      const user = authState.user

      // Check access
      if (!checkAccess()) return

      const roleColor = user.role === 'owner' ? 'var(--accent)' : user.role === 'admin' ? 'var(--success)' : 'var(--text-4)'
      const roleLabel = user.role === 'owner' ? 'Owner' : user.role === 'admin' ? 'Admin' : 'User'

      // Generate initials for avatar
      const name = user.name || user.email
      const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)

      // Check if we're in mock mode
      const isMockMode = new URLSearchParams(window.location.search).get('mock') === 'true'

      container.innerHTML = `
        <button id="userBtn" class="btn btn-ghost flex items-center gap-2 px-2 py-1.5">
          ${user.picture ? `
            <img src="${user.picture}" alt="${user.name}" class="w-7 h-7" style="border-radius:var(--radius-md);object-fit:cover">
          ` : `
            <div class="w-7 h-7 flex items-center justify-center" style="background:var(--accent);border-radius:var(--radius-md);font-weight:600;font-size:11px;color:white;letter-spacing:-0.5px">
              ${initials}
            </div>
          `}
          <div class="flex flex-col items-start">
            <div class="flex items-center gap-1">
              <span class="text-label leading-none" style="color:var(--text-1)">${user.name || user.email}</span>
              ${isMockMode ? `<span class="text-micro px-1 py-0.5" style="background:var(--warning);color:white;border-radius:2px;font-weight:600">MOCK</span>` : ''}
            </div>
            <span class="text-micro leading-none" style="color:${roleColor}">${roleLabel}</span>
          </div>
          <i data-lucide="chevron-down" class="w-3 h-3" style="color:var(--text-4)"></i>
        </button>
      `
      lucide.createIcons()

      // Render dropdown
      renderUserDropdown(user)

      // Attach click handler
      document.getElementById('userBtn')?.addEventListener('click', (e) => {
        e.stopPropagation()
        const dropdown = document.getElementById('userDropdown')
        const wasHidden = dropdown?.classList.contains('hidden')
        document.querySelectorAll('.dropdown').forEach(d => d.classList.add('hidden'))
        if (wasHidden) dropdown?.classList.remove('hidden')
      })
    }

    // Render user dropdown
    function renderUserDropdown(user) {
      const dropdown = document.getElementById('userDropdown')
      const roleColor = user.role === 'owner' ? 'var(--accent)' : user.role === 'admin' ? 'var(--success)' : 'var(--text-4)'
      const providerIcon = getProviderIcon(user.provider)
      const providerName = getProviderName(user.provider)

      // Generate initials for avatar
      const name = user.name || user.email
      const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)

      // Check if we're in mock mode
      const isMockMode = new URLSearchParams(window.location.search).get('mock') === 'true'

      dropdown.innerHTML = `
        <div class="px-4 py-3 border-b" style="border-color:var(--border)">
          ${isMockMode ? `
            <div class="flex items-center gap-1.5 px-2 py-1.5 mb-2" style="background:var(--warning-soft);border-radius:var(--radius-sm);border:1px solid var(--warning)">
              <i data-lucide="alert-circle" class="w-3.5 h-3.5" style="color:var(--warning)"></i>
              <span class="text-caption" style="color:var(--warning);font-weight:500">Mock Mode Active</span>
            </div>
          ` : ''}
          <div class="flex items-center gap-2 mb-2">
            ${user.picture ? `
              <img src="${user.picture}" alt="${user.name}" class="w-10 h-10" style="border-radius:var(--radius-md);object-fit:cover">
            ` : `
              <div class="w-10 h-10 flex items-center justify-center" style="background:var(--accent);border-radius:var(--radius-md);font-weight:600;font-size:14px;color:white;letter-spacing:-0.5px">
                ${initials}
              </div>
            `}
            <div class="flex-1">
              <div class="flex items-center gap-1.5">
                <div class="text-label" style="color:var(--text-1)">${user.name || user.email}</div>
                <span class="text-micro px-1.5 py-0.5" style="background:var(--bg-3);color:${roleColor};border-radius:var(--radius-sm);font-weight:600">${user.role.toUpperCase()}</span>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-1.5">
            <div class="text-caption flex-1" style="color:var(--text-3)">${user.email}</div>
            <div class="flex items-center gap-1 px-1.5 py-0.5" style="background:var(--bg-2);border-radius:var(--radius-sm)" title="Signed in with ${providerName}">
              <i data-lucide="${providerIcon}" class="w-3 h-3" style="color:var(--text-3)"></i>
              <span class="text-micro" style="color:var(--text-3);font-weight:500">${providerName}</span>
            </div>
          </div>
        </div>
        <div class="py-1">
          <a href="/settings" class="flex items-center gap-2.5 px-4 py-2 text-label dropdown-item" style="color:var(--text-2)">
            <i data-lucide="settings" class="w-4 h-4"></i>
            Settings
          </a>
        </div>
        <div class="py-1 border-t" style="border-color:var(--border)">
          <button id="signOutBtn" class="w-full flex items-center gap-2.5 px-4 py-2 text-label dropdown-item" style="color:var(--error);background:transparent;border:none;cursor:pointer;text-align:left">
            <i data-lucide="log-out" class="w-4 h-4"></i>
            Sign out
          </button>
        </div>
      `
      lucide.createIcons()

      // Attach sign out handler with better error handling
      const signOutBtn = document.getElementById('signOutBtn')
      if (signOutBtn) {
        signOutBtn.addEventListener('click', async (e) => {
          e.preventDefault()
          e.stopPropagation()

          // Close dropdown immediately
          dropdown.classList.add('hidden')

          try {
            console.log('[Admin] Signing out...')
            await signOut(client)
          } catch (err) {
            console.error('[Admin] Sign out error:', err)
            alert('Failed to sign out: ' + err.message)
          }
        })
      }
    }

    function init() {
      lucide.createIcons()
      initTheme()
      pageContainer = document.getElementById('page-content')

      // Subscribe to auth changes
      auth.subscribe(renderUserHeader)

      // Subscribe to app changes for breadcrumb updates
      currentApp.subscribe(() => {
        const match = router.current.get()
        if (match) updateBreadcrumb(match)
      })

      // Sidebar toggle (desktop collapse)
      document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
        toggleSidebar()
        document.getElementById('sidebar')?.classList.toggle('collapsed', sidebarCollapsed.get())
      })

      // Mobile menu toggle
      const mobileMenuBtn = document.getElementById('mobile-menu-btn')
      const sidebar = document.getElementById('sidebar')
      const sidebarBackdrop = document.getElementById('sidebar-backdrop')

      function openMobileMenu() {
        sidebar?.classList.add('mobile-open')
        sidebarBackdrop?.classList.add('active')
        document.body.style.overflow = 'hidden'
      }

      function closeMobileMenu() {
        sidebar?.classList.remove('mobile-open')
        sidebarBackdrop?.classList.remove('active')
        document.body.style.overflow = ''
      }

      mobileMenuBtn?.addEventListener('click', (e) => {
        e.stopPropagation()
        if (sidebar?.classList.contains('mobile-open')) {
          closeMobileMenu()
        } else {
          openMobileMenu()
        }
      })

      // Close mobile menu when clicking backdrop
      sidebarBackdrop?.addEventListener('click', closeMobileMenu)

      // Close mobile menu when clicking a nav link
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          // Only close on mobile (check if mobile menu is open)
          if (sidebar?.classList.contains('mobile-open')) {
            closeMobileMenu()
          }
        })
      })

      // Close mobile menu on window resize to desktop size
      let resizeTimer
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer)
        resizeTimer = setTimeout(() => {
          if (window.innerWidth >= 1024 && sidebar?.classList.contains('mobile-open')) {
            closeMobileMenu()
          }
        }, 250)
      })

      // Menu toggles
      document.querySelectorAll('.menu-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
          toggle.classList.toggle('open')
          toggle.parentElement?.nextElementSibling?.classList.toggle('open')
        })
      })

      // Nav link click handlers (use router, prevent full reload)
      document.querySelectorAll('a[href^="/"]').forEach(link => {
        link.addEventListener('click', (e) => {
          const href = link.getAttribute('href')
          // Only intercept internal links
          if (href && !href.startsWith('//') && !href.startsWith('http')) {
            e.preventDefault()
            router.push(href)
          }
        })
      })

      // Theme buttons
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setTheme(btn.dataset.theme)
          document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'))
          btn.classList.add('active')
        })
      })

      // Palette swatches
      document.querySelectorAll('.swatch').forEach(swatch => {
        swatch.addEventListener('click', () => {
          setPalette(swatch.dataset.palette)
          document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'))
          swatch.classList.add('active')
        })
      })

      // Command palette
      const paletteEl = document.getElementById('command-palette')
      const backdropEl = document.getElementById('command-backdrop')
      const inputEl = document.getElementById('command-input')
      const resultsEl = document.getElementById('command-results')

      commands.isOpen.subscribe(isOpen => {
        paletteEl?.classList.toggle('hidden', !isOpen)
        backdropEl?.classList.toggle('hidden', !isOpen)
        if (isOpen) {
          inputEl?.focus()
          inputEl.value = ''
          renderCommandResults()
        }
      })

      backdropEl?.addEventListener('click', () => commands.close())
      document.getElementById('openCommandPalette')?.addEventListener('click', () => commands.open())

      inputEl?.addEventListener('input', (e) => {
        commands.query.set(e.target.value)
        renderCommandResults()
      })

      inputEl?.addEventListener('keydown', (e) => commands.handleKeyDown(e))

      function renderCommandResults() {
        const cmds = commands.filteredCommands.get()
        const selected = commands.selectedIndex.get()
        resultsEl.innerHTML = cmds.map((cmd, i) => `
          <div class="dropdown-item flex items-center gap-3 px-4 py-2.5 cursor-pointer ${i === selected ? 'active' : ''}" data-command="${cmd.id}" style="${i === selected ? 'background: var(--bg-2)' : ''}">
            <i data-lucide="${cmd.icon || 'terminal'}" class="w-4 h-4 text-muted"></i>
            <span class="text-label text-primary flex-1">${cmd.title}</span>
            ${cmd.shortcut ? `<kbd class="kbd">${cmd.shortcut}</kbd>` : ''}
          </div>
        `).join('')
        lucide.createIcons()
        resultsEl.querySelectorAll('[data-command]').forEach(item => {
          item.addEventListener('click', () => commands.execute(item.dataset.command))
        })
      }

      // Dropdowns - close all when clicking outside
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown').forEach(d => d.classList.add('hidden'))
      })

      document.getElementById('notificationsBtn')?.addEventListener('click', (e) => {
        e.stopPropagation()
        const dropdown = document.getElementById('notificationsDropdown')
        const wasHidden = dropdown?.classList.contains('hidden')
        document.querySelectorAll('.dropdown').forEach(d => d.classList.add('hidden'))
        if (wasHidden) dropdown?.classList.remove('hidden')
      })

      // New App Modal
      const newAppModal = document.getElementById('newAppModal')
      const closeNewApp = document.getElementById('closeNewApp')
      const closeNewAppX = document.getElementById('closeNewAppX')
      const newAppForm = document.getElementById('newAppForm')
      const newAppNameInput = document.getElementById('newAppName')
      const newAppTemplateInput = document.getElementById('newAppTemplate')
      const submitNewAppBtn = document.getElementById('submitNewApp')
      const newAppError = document.getElementById('newAppError')
      const newAppErrorText = document.getElementById('newAppErrorText')

      function closeNewAppModal() {
        newAppModal?.classList.add('hidden')
        newAppModal?.classList.remove('flex')
        // Reset form state
        newAppForm?.reset()
        newAppError?.classList.add('hidden')
        submitNewAppBtn.disabled = false
        document.getElementById('submitNewAppText').classList.remove('hidden')
        document.getElementById('submitNewAppLoading').classList.add('hidden')
        // Reset template selection
        document.querySelectorAll('.template-option').forEach((btn, i) => {
          btn.style.borderColor = i === 0 ? 'var(--accent)' : 'var(--border-subtle)'
        })
        newAppTemplateInput.value = 'minimal'
      }

      function openNewAppModal() {
        newAppModal?.classList.remove('hidden')
        newAppModal?.classList.add('flex')
        lucide.createIcons()
        newAppNameInput?.focus()
      }

      closeNewApp?.addEventListener('click', closeNewAppModal)
      closeNewAppX?.addEventListener('click', closeNewAppModal)

      // Template selection
      document.querySelectorAll('.template-option').forEach(btn => {
        btn.addEventListener('click', () => {
          // Update border colors
          document.querySelectorAll('.template-option').forEach(b => {
            b.style.borderColor = 'var(--border-subtle)'
          })
          btn.style.borderColor = 'var(--accent)'
          // Update hidden input
          newAppTemplateInput.value = btn.dataset.template
        })
      })

      // Form submission
      submitNewAppBtn?.addEventListener('click', async () => {
        const name = newAppNameInput?.value?.trim()
        const template = newAppTemplateInput?.value || 'minimal'

        if (!name) {
          newAppErrorText.textContent = 'App name is required'
          newAppError?.classList.remove('hidden')
          return
        }

        if (!/^[a-z0-9-]+$/.test(name)) {
          newAppErrorText.textContent = 'Name must be lowercase letters, numbers, and dashes only'
          newAppError?.classList.remove('hidden')
          return
        }

        // Show loading state
        submitNewAppBtn.disabled = true
        document.getElementById('submitNewAppText').classList.add('hidden')
        document.getElementById('submitNewAppLoading').classList.remove('hidden')
        newAppError?.classList.add('hidden')

        try {
          await createApp(client, name, template)
          closeNewAppModal()
          // Navigate to apps list
          router.push('/apps')
        } catch (err) {
          newAppErrorText.textContent = err.message || 'Failed to create app'
          newAppError?.classList.remove('hidden')
          submitNewAppBtn.disabled = false
          document.getElementById('submitNewAppText').classList.remove('hidden')
          document.getElementById('submitNewAppLoading').classList.add('hidden')
        }
      })

      // Close modal when clicking backdrop
      newAppModal?.addEventListener('click', (e) => {
        if (e.target === newAppModal) closeNewAppModal()
      })

      // Expose openNewAppModal globally for use from pages
      window.__fazt_openNewAppModal = openNewAppModal

      // Create Alias Modal
      const createAliasModal = document.getElementById('createAliasModal')
      const closeCreateAlias = document.getElementById('closeCreateAlias')
      const closeCreateAliasX = document.getElementById('closeCreateAliasX')
      const submitCreateAliasBtn = document.getElementById('submitCreateAlias')
      const createAliasError = document.getElementById('createAliasError')
      const aliasTypeInput = document.getElementById('aliasType')
      const aliasProxyTarget = document.getElementById('aliasProxyTarget')
      const aliasRedirectTarget = document.getElementById('aliasRedirectTarget')
      const aliasAppIdInput = document.getElementById('aliasAppId')
      const aliasAppSelect = document.getElementById('aliasAppSelect')
      const aliasAppDropdown = document.getElementById('aliasAppDropdown')
      const aliasAppSearch = document.getElementById('aliasAppSearch')
      const aliasAppList = document.getElementById('aliasAppList')
      const aliasAppSelectText = document.getElementById('aliasAppSelectText')

      // Searchable app dropdown for Create Alias
      function renderAliasAppList(searchTerm = '') {
        const appList = apps.get()
        const filtered = searchTerm
          ? appList.filter(app =>
              app.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              app.id.toLowerCase().includes(searchTerm.toLowerCase())
            )
          : appList

        if (filtered.length === 0) {
          aliasAppList.innerHTML = `<div class="px-4 py-3 text-caption text-muted">No apps found</div>`
          return
        }

        aliasAppList.innerHTML = filtered.map(app => `
          <div class="dropdown-item px-4 py-2 cursor-pointer" data-app-id="${app.id}" data-app-name="${app.name}">
            <div class="text-label text-primary">${app.name}</div>
            <div class="text-caption mono text-faint">${app.id}</div>
          </div>
        `).join('')

        aliasAppList.querySelectorAll('[data-app-id]').forEach(item => {
          item.addEventListener('click', () => {
            aliasAppIdInput.value = item.dataset.appId
            aliasAppSelectText.textContent = item.dataset.appName
            aliasAppSelectText.classList.remove('text-muted')
            aliasAppSelectText.classList.add('text-primary')
            aliasAppDropdown.classList.add('hidden')
          })
        })
      }

      aliasAppSelect?.addEventListener('click', (e) => {
        e.stopPropagation()
        aliasAppDropdown.classList.toggle('hidden')
        if (!aliasAppDropdown.classList.contains('hidden')) {
          aliasAppSearch.value = ''
          renderAliasAppList()
          aliasAppSearch.focus()
        }
      })

      aliasAppSearch?.addEventListener('input', (e) => {
        renderAliasAppList(e.target.value)
      })

      aliasAppSearch?.addEventListener('click', (e) => e.stopPropagation())

      function closeCreateAliasModal() {
        createAliasModal?.classList.add('hidden')
        createAliasModal?.classList.remove('flex')
        document.getElementById('createAliasForm')?.reset()
        createAliasError?.classList.add('hidden')
        submitCreateAliasBtn.disabled = false
        document.getElementById('submitCreateAliasText').classList.remove('hidden')
        document.getElementById('submitCreateAliasLoading').classList.add('hidden')
        // Reset type selection
        document.querySelectorAll('.alias-type-btn').forEach((btn, i) => {
          btn.style.borderColor = i === 0 ? 'var(--accent)' : 'var(--border-subtle)'
          btn.style.background = i === 0 ? 'var(--accent-soft)' : 'var(--bg-2)'
        })
        aliasTypeInput.value = 'proxy'
        aliasProxyTarget?.classList.remove('hidden')
        aliasRedirectTarget?.classList.add('hidden')
        // Reset app select
        aliasAppIdInput.value = ''
        aliasAppSelectText.textContent = 'Select an app...'
        aliasAppSelectText.classList.add('text-muted')
        aliasAppSelectText.classList.remove('text-primary')
        aliasAppDropdown?.classList.add('hidden')
      }

      function openCreateAliasModal() {
        renderAliasAppList()
        createAliasModal?.classList.remove('hidden')
        createAliasModal?.classList.add('flex')
        lucide.createIcons()
        document.getElementById('aliasSubdomain')?.focus()
      }

      closeCreateAlias?.addEventListener('click', closeCreateAliasModal)
      closeCreateAliasX?.addEventListener('click', closeCreateAliasModal)

      // Type selection for create alias
      document.querySelectorAll('.alias-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.alias-type-btn').forEach(b => {
            b.style.borderColor = 'var(--border-subtle)'
            b.style.background = 'var(--bg-2)'
          })
          btn.style.borderColor = 'var(--accent)'
          btn.style.background = 'var(--accent-soft)'
          aliasTypeInput.value = btn.dataset.type

          // Show/hide target fields
          if (btn.dataset.type === 'proxy') {
            aliasProxyTarget?.classList.remove('hidden')
            aliasRedirectTarget?.classList.add('hidden')
          } else if (btn.dataset.type === 'redirect') {
            aliasProxyTarget?.classList.add('hidden')
            aliasRedirectTarget?.classList.remove('hidden')
          } else {
            aliasProxyTarget?.classList.add('hidden')
            aliasRedirectTarget?.classList.add('hidden')
          }
        })
      })

      // Submit create alias
      submitCreateAliasBtn?.addEventListener('click', async () => {
        const subdomain = document.getElementById('aliasSubdomain')?.value?.trim()
        const type = aliasTypeInput?.value || 'proxy'
        const appId = aliasAppIdInput?.value
        const redirectUrl = document.getElementById('aliasRedirectUrl')?.value?.trim()

        if (!subdomain) {
          document.getElementById('createAliasErrorText').textContent = 'Subdomain is required'
          createAliasError?.classList.remove('hidden')
          return
        }

        if (type === 'proxy' && !appId) {
          document.getElementById('createAliasErrorText').textContent = 'Please select a target app'
          createAliasError?.classList.remove('hidden')
          return
        }

        if (type === 'redirect' && !redirectUrl) {
          document.getElementById('createAliasErrorText').textContent = 'Redirect URL is required'
          createAliasError?.classList.remove('hidden')
          return
        }

        // Show loading
        submitCreateAliasBtn.disabled = true
        document.getElementById('submitCreateAliasText').classList.add('hidden')
        document.getElementById('submitCreateAliasLoading').classList.remove('hidden')
        createAliasError?.classList.add('hidden')

        try {
          const options = type === 'proxy' ? { app_id: appId } : type === 'redirect' ? { url: redirectUrl } : {}
          await createAlias(client, subdomain, type, options)
          closeCreateAliasModal()
        } catch (err) {
          document.getElementById('createAliasErrorText').textContent = err.message || 'Failed to create alias'
          createAliasError?.classList.remove('hidden')
          submitCreateAliasBtn.disabled = false
          document.getElementById('submitCreateAliasText').classList.remove('hidden')
          document.getElementById('submitCreateAliasLoading').classList.add('hidden')
        }
      })

      createAliasModal?.addEventListener('click', (e) => {
        if (e.target === createAliasModal) closeCreateAliasModal()
        // Close app dropdown when clicking outside
        if (!e.target.closest('.app-select-container')) {
          aliasAppDropdown?.classList.add('hidden')
        }
      })

      // Edit Alias Modal
      const editAliasModal = document.getElementById('editAliasModal')
      const closeEditAlias = document.getElementById('closeEditAlias')
      const closeEditAliasX = document.getElementById('closeEditAliasX')
      const submitEditAliasBtn = document.getElementById('submitEditAlias')
      const deleteAliasBtn = document.getElementById('deleteAlias')
      const editAliasError = document.getElementById('editAliasError')
      const editAliasAppIdInput = document.getElementById('editAliasAppId')
      const editAliasAppSelect = document.getElementById('editAliasAppSelect')
      const editAliasAppDropdown = document.getElementById('editAliasAppDropdown')
      const editAliasAppSearch = document.getElementById('editAliasAppSearch')
      const editAliasAppList = document.getElementById('editAliasAppList')
      const editAliasAppSelectText = document.getElementById('editAliasAppSelectText')

      // Searchable app dropdown for Edit Alias
      function renderEditAliasAppList(searchTerm = '') {
        const appList = apps.get()
        const filtered = searchTerm
          ? appList.filter(app =>
              app.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              app.id.toLowerCase().includes(searchTerm.toLowerCase())
            )
          : appList

        if (filtered.length === 0) {
          editAliasAppList.innerHTML = `<div class="px-4 py-3 text-caption text-muted">No apps found</div>`
          return
        }

        editAliasAppList.innerHTML = filtered.map(app => `
          <div class="dropdown-item px-4 py-2 cursor-pointer" data-app-id="${app.id}" data-app-name="${app.name}">
            <div class="text-label text-primary">${app.name}</div>
            <div class="text-caption mono text-faint">${app.id}</div>
          </div>
        `).join('')

        editAliasAppList.querySelectorAll('[data-app-id]').forEach(item => {
          item.addEventListener('click', () => {
            editAliasAppIdInput.value = item.dataset.appId
            editAliasAppSelectText.textContent = item.dataset.appName
            editAliasAppSelectText.classList.remove('text-muted')
            editAliasAppSelectText.classList.add('text-primary')
            editAliasAppDropdown.classList.add('hidden')
          })
        })
      }

      editAliasAppSelect?.addEventListener('click', (e) => {
        e.stopPropagation()
        editAliasAppDropdown.classList.toggle('hidden')
        if (!editAliasAppDropdown.classList.contains('hidden')) {
          editAliasAppSearch.value = ''
          renderEditAliasAppList()
          editAliasAppSearch.focus()
        }
      })

      editAliasAppSearch?.addEventListener('input', (e) => {
        renderEditAliasAppList(e.target.value)
      })

      editAliasAppSearch?.addEventListener('click', (e) => e.stopPropagation())

      function closeEditAliasModal() {
        editAliasModal?.classList.add('hidden')
        editAliasModal?.classList.remove('flex')
        document.getElementById('editAliasForm')?.reset()
        editAliasError?.classList.add('hidden')
        submitEditAliasBtn.disabled = false
        document.getElementById('submitEditAliasText').classList.remove('hidden')
        document.getElementById('submitEditAliasLoading').classList.add('hidden')
        // Reset app select
        editAliasAppIdInput.value = ''
        editAliasAppSelectText.textContent = 'Select an app...'
        editAliasAppSelectText.classList.add('text-muted')
        editAliasAppSelectText.classList.remove('text-primary')
        editAliasAppDropdown?.classList.add('hidden')
      }

      function openEditAliasModal(alias) {
        // Fill form
        document.getElementById('editAliasSubdomain').value = alias.subdomain
        document.getElementById('editAliasSubtitle').textContent = alias.subdomain
        document.getElementById('editAliasTypeDisplay').textContent = alias.type

        if (alias.type === 'proxy') {
          document.getElementById('editAliasProxyTarget')?.classList.remove('hidden')
          document.getElementById('editAliasRedirectTarget')?.classList.add('hidden')
          editAliasAppIdInput.value = alias.targets?.app_id || ''
          // Set the display text
          const appList = apps.get()
          const selectedApp = appList.find(a => a.id === alias.targets?.app_id)
          if (selectedApp) {
            editAliasAppSelectText.textContent = selectedApp.name
            editAliasAppSelectText.classList.remove('text-muted')
            editAliasAppSelectText.classList.add('text-primary')
          } else {
            editAliasAppSelectText.textContent = 'Select an app...'
            editAliasAppSelectText.classList.add('text-muted')
            editAliasAppSelectText.classList.remove('text-primary')
          }
        } else if (alias.type === 'redirect') {
          document.getElementById('editAliasProxyTarget')?.classList.add('hidden')
          document.getElementById('editAliasRedirectTarget')?.classList.remove('hidden')
          document.getElementById('editAliasRedirectUrl').value = alias.targets?.url || ''
        } else {
          document.getElementById('editAliasProxyTarget')?.classList.add('hidden')
          document.getElementById('editAliasRedirectTarget')?.classList.add('hidden')
        }

        renderEditAliasAppList()
        editAliasModal?.classList.remove('hidden')
        editAliasModal?.classList.add('flex')
        lucide.createIcons()
      }

      closeEditAlias?.addEventListener('click', closeEditAliasModal)
      closeEditAliasX?.addEventListener('click', closeEditAliasModal)

      // Submit edit alias
      submitEditAliasBtn?.addEventListener('click', async () => {
        const subdomain = document.getElementById('editAliasSubdomain')?.value
        const type = document.getElementById('editAliasTypeDisplay')?.textContent
        const appId = editAliasAppIdInput?.value
        const redirectUrl = document.getElementById('editAliasRedirectUrl')?.value?.trim()

        if (type === 'proxy' && !appId) {
          document.getElementById('editAliasErrorText').textContent = 'Please select a target app'
          editAliasError?.classList.remove('hidden')
          return
        }

        // Show loading
        submitEditAliasBtn.disabled = true
        document.getElementById('submitEditAliasText').classList.add('hidden')
        document.getElementById('submitEditAliasLoading').classList.remove('hidden')
        editAliasError?.classList.add('hidden')

        try {
          const data = type === 'proxy' ? { targets: { app_id: appId } } : type === 'redirect' ? { targets: { url: redirectUrl } } : {}
          await updateAlias(client, subdomain, data)
          closeEditAliasModal()
        } catch (err) {
          document.getElementById('editAliasErrorText').textContent = err.message || 'Failed to update alias'
          editAliasError?.classList.remove('hidden')
          submitEditAliasBtn.disabled = false
          document.getElementById('submitEditAliasText').classList.remove('hidden')
          document.getElementById('submitEditAliasLoading').classList.add('hidden')
        }
      })

      // Delete alias
      deleteAliasBtn?.addEventListener('click', async () => {
        const subdomain = document.getElementById('editAliasSubdomain')?.value
        if (confirm(`Delete alias "${subdomain}"? This cannot be undone.`)) {
          try {
            await deleteAlias(client, subdomain)
            closeEditAliasModal()
          } catch (err) {
            document.getElementById('editAliasErrorText').textContent = err.message || 'Failed to delete alias'
            editAliasError?.classList.remove('hidden')
          }
        }
      })

      editAliasModal?.addEventListener('click', (e) => {
        if (e.target === editAliasModal) closeEditAliasModal()
        // Close app dropdown when clicking outside
        if (!e.target.closest('.app-select-container')) {
          editAliasAppDropdown?.classList.add('hidden')
        }
      })

      // Global Escape key handler for all modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (!newAppModal?.classList.contains('hidden')) {
            closeNewAppModal()
          }
          if (!createAliasModal?.classList.contains('hidden')) {
            closeCreateAliasModal()
          }
          if (!editAliasModal?.classList.contains('hidden')) {
            closeEditAliasModal()
          }
          // Close any open app dropdowns
          aliasAppDropdown?.classList.add('hidden')
          editAliasAppDropdown?.classList.add('hidden')
        }
      })

      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.app-select-container')) {
          aliasAppDropdown?.classList.add('hidden')
          editAliasAppDropdown?.classList.add('hidden')
        }
      })

      // Expose alias modals globally for use from pages
      window.__fazt_openCreateAliasModal = openCreateAliasModal
      window.__fazt_openEditAliasModal = openEditAliasModal

      // Draggable settings panel
      let isDragging = false
      let dragOffset = { x: 0, y: 0 }
      const panel = document.getElementById('settingsPanel')
      const handle = document.getElementById('settings-drag-handle')

      handle?.addEventListener('mousedown', (e) => {
        isDragging = true
        const rect = panel.getBoundingClientRect()
        dragOffset.x = e.clientX - rect.left
        dragOffset.y = e.clientY - rect.top
        panel.style.transform = 'none'
        panel.style.left = rect.left + 'px'
        panel.style.top = rect.top + 'px'
        panel.style.bottom = 'auto'
      })

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return
        const rect = panel.getBoundingClientRect()
        let x = Math.max(0, Math.min(e.clientX - dragOffset.x, window.innerWidth - rect.width))
        let y = Math.max(0, Math.min(e.clientY - dragOffset.y, window.innerHeight - rect.height))
        panel.style.left = x + 'px'
        panel.style.top = y + 'px'
      })

      document.addEventListener('mouseup', () => isDragging = false)

      // Mock toggle
      const toggleMockBtn = document.getElementById('toggleMock')
      const updateMockButton = () => {
        if (toggleMockBtn) {
          if (useMock) {
            toggleMockBtn.style.color = 'var(--accent)'
            toggleMockBtn.style.background = 'var(--accent-soft)'
          } else {
            toggleMockBtn.style.color = 'var(--text-4)'
            toggleMockBtn.style.background = 'transparent'
          }
        }
      }
      updateMockButton()

      toggleMockBtn?.addEventListener('click', () => {
        const url = new URL(window.location.href)
        if (useMock) {
          url.searchParams.delete('mock')
        } else {
          url.searchParams.set('mock', 'true')
        }
        window.location.href = url.toString()
      })

      // Settings panel toggle
      const toggleSettingsBtn = document.getElementById('toggleSettingsPanel')
      const updateSettingsButton = () => {
        if (toggleSettingsBtn) {
          const isHidden = panel?.classList.contains('hidden')
          if (!isHidden) {
            toggleSettingsBtn.style.color = 'var(--accent)'
            toggleSettingsBtn.style.background = 'var(--accent-soft)'
          } else {
            toggleSettingsBtn.style.color = 'var(--text-4)'
            toggleSettingsBtn.style.background = 'transparent'
          }
        }
      }

      toggleSettingsBtn?.addEventListener('click', () => {
        panel?.classList.toggle('hidden')
        updateSettingsButton()
      })
      updateSettingsButton()

      // Load auth and data, then render initial route
      // In mock mode, force immediate auth state update
      if (useMock) {
        console.log('[Admin] Mock mode: forcing mock user load')
        // Clear any existing auth state first
        auth.set({
          authenticated: false,
          user: null,
          loading: true
        })
      }

      Promise.all([
        loadAuth(client),
        loadData()
      ]).then(() => {
        const match = router.current.get()
        if (match) {
          renderPage(match)
          updateBreadcrumb(match)
          updateNav(match)
        }
      })

      console.log('[Fazt Admin] Initialized', useMock ? '(mock mode)' : '')
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init)
    } else {
      init()
    }

    window.__fazt_admin = { router, commands, client, loadData }
  </script>
</body>
</html>
